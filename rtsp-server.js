/**
 * RTSP Integration Server - ES Modules –≤–µ—Ä—Å–∏—è
 * –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å package.json "type": "module"
 */

import http from 'http';
import fs from 'fs';
import path from 'path';
import url from 'url';
import bcrypt from 'bcrypt';
import RTSPStreamManager from './rtsp-stream-manager.js';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

class RTSPIntegrationServer {
    constructor() {
        this.streamManager = new RTSPStreamManager();
        this.sessions = new Map();
        this.currentConfig = null;
        this.currentApartmentIndex = 0;
        this.cycleTimer = null;
        this.cycleInterval = 15000; // 15 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        this.isRTSPEnabled = false; // –§–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω–∏—è RTSP —Ä–µ–∂–∏–º–∞
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        this.loadConfig();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π stream manager
        this.setupStreamManagerEvents();
        
        // –°–æ–∑–¥–∞–Ω–∏–µ HTTP —Å–µ—Ä–≤–µ—Ä–∞
        this.server = http.createServer((req, res) => this.handleRequest(req, res));
        
        console.log('üöÄ RTSP Integration Server –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    /**
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π stream manager
     */
    setupStreamManagerEvents() {
        this.streamManager.on('streamConnected', ({ streamId, camera }) => {
            console.log(`‚úÖ –ü–æ—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω: ${camera.camera_name} (${streamId})`);
        });

        this.streamManager.on('streamError', ({ streamId, camera, error, attempts }) => {
            console.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞ ${camera.camera_name}: ${error} (–ø–æ–ø—ã—Ç–∫–∞ ${attempts})`);
        });

        this.streamManager.on('streamFailed', ({ streamId, camera }) => {
            console.log(`üíÄ –ü–æ—Ç–æ–∫ ${camera.camera_name} –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
        });
    }

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    loadConfig() {
        try {
            const configPath = path.join(__dirname, 'config.json');
            if (fs.existsSync(configPath)) {
                const configData = fs.readFileSync(configPath, 'utf8');
                this.currentConfig = JSON.parse(configData);
                console.log('üìñ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            } else {
                console.log('‚ö†Ô∏è –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è mock —Ä–µ–∂–∏–º');
                this.currentConfig = this.generateMockConfig();
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:', error.message);
            this.currentConfig = this.generateMockConfig();
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è mock –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
     */
    generateMockConfig() {
        return {
            users: [
                {
                    login: "admin",
                    password_hash: "$2b$10$CwTycUXWue0Thq9StjUM0uJ8E5zQ0B9H.VQ8S8IUo2z2N7fFG7/mC", // admin123
                    role: "admin"
                }
            ],
            apartments: [
                { id: 1, apartment_name: "–¢–µ—Å—Ç–æ–≤–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞", apartment_number: "TEST-1" }
            ],
            cameras: [
                {
                    id: 1,
                    camera_name: "–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞–º–µ—Ä–∞",
                    apartment_name: "–¢–µ—Å—Ç–æ–≤–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞",
                    rtsp_link: "rtsp://demo:demo@ipvmdemo.dyndns.org:554/onvif-media/media.amp?profile=profile_1_h264",
                    rtsp_hd_link: "rtsp://demo:demo@ipvmdemo.dyndns.org:554/onvif-media/media.amp?profile=profile_2_h264",
                    enabled: true
                }
            ],
            settings: {
                rotation_interval: 15,
                connection_timeout: 10
            }
        };
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
     */
    async handleRequest(req, res) {
        const parsedUrl = url.parse(req.url, true);
        const pathname = parsedUrl.pathname;
        const method = req.method;

        // CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
        res.setHeader('Access-Control-Allow-Origin', '*');
        res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
        res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');

        if (method === 'OPTIONS') {
            res.writeHead(200);
            res.end();
            return;
        }

        try {
            // –†–æ—É—Ç–∏–Ω–≥
            if (pathname === '/') {
                await this.serveFile(path.join(__dirname, 'index.html'), res);
            } else if (pathname === '/api/login') {
                await this.handleLogin(req, res);
            } else if (pathname === '/api/apartments') {
                await this.handleApartments(req, res);
            } else if (pathname === '/api/cameras') {
                await this.handleCameras(req, res);
            } else if (pathname === '/api/rtsp/toggle') {
                await this.handleRTSPToggle(req, res);
            } else if (pathname === '/api/rtsp/status') {
                await this.handleRTSPStatus(req, res);
            } else if (pathname === '/api/rtsp/streams') {
                await this.handleStreamStatus(req, res);
            } else if (pathname.startsWith('/stream_output/')) {
                await this.serveStreamFile(pathname, res);
            } else if (pathname.startsWith('/api/stream/start')) {
                await this.handleStreamStart(req, res);
            } else if (pathname.startsWith('/api/stream/stop')) {
                await this.handleStreamStop(req, res);
            } else if (fs.existsSync(path.join(__dirname, pathname.slice(1)))) {
                await this.serveFile(path.join(__dirname, pathname.slice(1)), res);
            } else {
                this.send404(res);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
            this.sendError(res, 500, '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è RTSP —Ä–µ–∂–∏–º–∞
     */
    async handleRTSPToggle(req, res) {
        if (req.method !== 'POST') {
            this.sendError(res, 405, '–ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            return;
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ FFmpeg
            const ffmpegAvailable = await RTSPStreamManager.checkFFmpegAvailability();
            if (!ffmpegAvailable) {
                this.sendJSON(res, {
                    success: false,
                    error: 'FFmpeg –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
                });
                return;
            }

            this.isRTSPEnabled = !this.isRTSPEnabled;

            if (this.isRTSPEnabled) {
                console.log('üé• RTSP —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω');
                await this.startCurrentApartmentStreams();
            } else {
                console.log('üõë RTSP —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω');
                await this.streamManager.stopAllStreams();
            }

            this.sendJSON(res, {
                success: true,
                rtspEnabled: this.isRTSPEnabled,
                message: this.isRTSPEnabled ? 'RTSP —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω' : 'RTSP —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω'
            });

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è RTSP:', error);
            this.sendJSON(res, {
                success: false,
                error: error.message
            });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ RTSP
     */
    async handleRTSPStatus(req, res) {
        const activeStreams = this.streamManager.getActiveStreams();
        const ffmpegAvailable = await RTSPStreamManager.checkFFmpegAvailability();

        this.sendJSON(res, {
            rtspEnabled: this.isRTSPEnabled,
            ffmpegAvailable: ffmpegAvailable,
            activeStreamCount: Object.keys(activeStreams).length,
            activeStreams: activeStreams
        });
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Ç–æ–∫–æ–≤
     */
    async handleStreamStatus(req, res) {
        const activeStreams = this.streamManager.getActiveStreams();
        this.sendJSON(res, activeStreams);
    }

    /**
     * –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
     */
    async startCurrentApartmentStreams() {
        if (!this.isRTSPEnabled || !this.currentConfig) return;

        const apartments = this.currentConfig.apartments;
        if (!apartments || apartments.length === 0) return;

        const currentApartment = apartments[this.currentApartmentIndex];
        const apartmentCameras = this.currentConfig.cameras.filter(
            camera => camera.apartment_name === currentApartment.apartment_name && camera.enabled
        );

        console.log(`üè† –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã: ${currentApartment.apartment_name}`);

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Ç–µ–∫—É—â–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
        await this.streamManager.stopAllStreams();

        // –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∫–∞–º–µ—Ä —Ç–µ–∫—É—â–µ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã (–Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–µ—Ç–∫–∏)
        const startPromises = apartmentCameras.map(async (camera) => {
            try {
                await this.streamManager.startStream(camera, 'low');
            } catch (error) {
                console.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫ –¥–ª—è –∫–∞–º–µ—Ä—ã ${camera.camera_name}:`, error.message);
            }
        });

        await Promise.all(startPromises);
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
     */
    async handleStreamStart(req, res) {
        if (req.method !== 'POST') {
            this.sendError(res, 405, '–ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            return;
        }

        try {
            const body = await this.parseJSON(req);
            const { cameraId, quality = 'low' } = body;

            const camera = this.currentConfig.cameras.find(c => c.id === cameraId);
            if (!camera) {
                this.sendJSON(res, {
                    success: false,
                    error: '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
                });
                return;
            }

            const streamId = await this.streamManager.startStream(camera, quality);
            
            this.sendJSON(res, {
                success: true,
                streamId: streamId,
                streamUrl: this.streamManager.getStreamUrl(streamId)
            });

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞:', error);
            this.sendJSON(res, {
                success: false,
                error: error.message
            });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞
     */
    async handleStreamStop(req, res) {
        if (req.method !== 'POST') {
            this.sendError(res, 405, '–ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            return;
        }

        try {
            const body = await this.parseJSON(req);
            const { streamId } = body;

            await this.streamManager.stopStream(streamId);
            
            this.sendJSON(res, {
                success: true,
                message: '–ü–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
            });

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞:', error);
            this.sendJSON(res, {
                success: false,
                error: error.message
            });
        }
    }

    /**
     * –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ—Ç–æ–∫–æ–≤
     */
    async serveStreamFile(pathname, res) {
        const filePath = path.join(__dirname, pathname);
        
        try {
            if (fs.existsSync(filePath)) {
                const ext = path.extname(filePath);
                let contentType = 'application/octet-stream';
                
                if (ext === '.m3u8') {
                    contentType = 'application/vnd.apple.mpegurl';
                } else if (ext === '.ts') {
                    contentType = 'video/mp2t';
                }
                
                res.setHeader('Content-Type', contentType);
                res.setHeader('Cache-Control', 'no-cache');
                
                const stream = fs.createReadStream(filePath);
                stream.pipe(res);
            } else {
                this.send404(res);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –ø–æ—Ç–æ–∫–∞:', error);
            this.send404(res);
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä —Å —É—á–µ—Ç–æ–º RTSP
     */
    async handleApartments(req, res) {
        if (req.method === 'GET') {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö
            const apartments = this.currentConfig.apartments.map(apt => {
                const cameras = this.currentConfig.cameras.filter(
                    cam => cam.apartment_name === apt.apartment_name
                );
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ URL –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∫–∞–º–µ—Ä
                const camerasWithStreams = cameras.map(camera => {
                    const streamId = `${camera.id}_low`;
                    const status = this.streamManager.getStreamStatus(streamId);
                    
                    return {
                        ...camera,
                        streamUrl: this.isRTSPEnabled && status === 'streaming' 
                            ? this.streamManager.getStreamUrl(streamId) 
                            : null,
                        streamStatus: status
                    };
                });

                return {
                    ...apt,
                    cameras: camerasWithStreams,
                    isActive: this.currentApartmentIndex === this.currentConfig.apartments.indexOf(apt)
                };
            });

            this.sendJSON(res, { 
                apartments,
                rtspEnabled: this.isRTSPEnabled,
                currentIndex: this.currentApartmentIndex
            });
        }
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–º–µ—Ä
     */
    async handleCameras(req, res) {
        if (req.method === 'GET') {
            const cameras = this.currentConfig.cameras.map(camera => {
                const streamIdLow = `${camera.id}_low`;
                const streamIdHigh = `${camera.id}_high`;
                
                return {
                    ...camera,
                    streams: {
                        low: {
                            url: this.isRTSPEnabled ? this.streamManager.getStreamUrl(streamIdLow) : null,
                            status: this.streamManager.getStreamStatus(streamIdLow)
                        },
                        high: {
                            url: this.isRTSPEnabled ? this.streamManager.getStreamUrl(streamIdHigh) : null,
                            status: this.streamManager.getStreamStatus(streamIdHigh)
                        }
                    }
                };
            });

            this.sendJSON(res, cameras);
        }
    }

    /**
     * –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º simple-server.cjs
     */
    async handleLogin(req, res) {
        if (req.method !== 'POST') {
            this.sendError(res, 405, '–ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            return;
        }

        try {
            const body = await this.parseJSON(req);
            const { login, password } = body;

            const user = this.currentConfig.users.find(u => u.login === login);
            if (!user) {
                this.sendJSON(res, { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
                return;
            }

            const passwordMatch = await bcrypt.compare(password, user.password_hash);
            if (!passwordMatch) {
                this.sendJSON(res, { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' });
                return;
            }

            const sessionId = this.generateSessionId();
            this.sessions.set(sessionId, {
                login: user.login,
                role: user.role,
                loginTime: new Date()
            });

            this.sendJSON(res, {
                success: true,
                sessionId: sessionId,
                role: user.role
            });

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            this.sendJSON(res, { success: false, error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
    }

    // –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    generateSessionId() {
        return Math.random().toString(36).substring(2, 15) + 
               Math.random().toString(36).substring(2, 15);
    }

    async parseJSON(req) {
        return new Promise((resolve, reject) => {
            let body = '';
            req.on('data', chunk => body += chunk.toString());
            req.on('end', () => {
                try {
                    resolve(JSON.parse(body));
                } catch (error) {
                    reject(error);
                }
            });
        });
    }

    sendJSON(res, data) {
        res.setHeader('Content-Type', 'application/json');
        res.writeHead(200);
        res.end(JSON.stringify(data));
    }

    sendError(res, status, message) {
        res.writeHead(status, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: message }));
    }

    send404(res) {
        res.writeHead(404, { 'Content-Type': 'text/plain; charset=utf-8' });
        res.end('404 - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    async serveFile(filePath, res) {
        try {
            if (fs.existsSync(filePath)) {
                const ext = path.extname(filePath);
                const contentTypes = {
                    '.html': 'text/html; charset=utf-8',
                    '.css': 'text/css',
                    '.js': 'application/javascript',
                    '.json': 'application/json',
                    '.png': 'image/png',
                    '.jpg': 'image/jpeg',
                    '.gif': 'image/gif',
                    '.ico': 'image/x-icon'
                };
                
                res.setHeader('Content-Type', contentTypes[ext] || 'text/plain');
                const stream = fs.createReadStream(filePath);
                stream.pipe(res);
            } else {
                this.send404(res);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
            this.send404(res);
        }
    }

    /**
     * –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
     */
    listen(port = 3000) {
        this.server.listen(port, () => {
            console.log(`üåê RTSP Integration Server –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${port}`);
            console.log(`üì± –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:${port} –≤ –±—Ä–∞—É–∑–µ—Ä–µ`);
            console.log(`üé• RTSP —Ä–µ–∂–∏–º: ${this.isRTSPEnabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`);
        });
    }

    /**
     * –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
     */
    async shutdown() {
        console.log('üõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞...');
        
        if (this.cycleTimer) {
            clearInterval(this.cycleTimer);
        }
        
        await this.streamManager.stopAllStreams();
        
        this.server.close(() => {
            console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            process.exit(0);
        });
    }
}

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const server = new RTSPIntegrationServer();
server.listen(3000);

// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ —Å–∏–≥–Ω–∞–ª–∞—Ö
process.on('SIGINT', () => server.shutdown());
process.on('SIGTERM', () => server.shutdown());
