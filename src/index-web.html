<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .login-card.hidden {
            display: none;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        h1 {
            margin-bottom: 10px;
            color: #333;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-accounts {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            font-size: 14px;
            text-align: left;
        }

        .test-accounts code {
            background: #e1e5fe;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .message {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .main-screen {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            min-width: 600px;
            min-height: 400px;
        }

        .main-screen.active {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        .web-notice {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #a5d6a7;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .status-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .status-label {
            color: #666;
            font-size: 0.9rem;
        }

        #content {
            background: #fafafa;
            padding: 20px;
            border-radius: 10px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div class="login-card" id="loginCard">
            <div class="logo">üìπ</div>
            <h1>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
            <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</p>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            <div class="success-message" id="successMessage" style="display: none;"></div>
            
            <form id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <label for="username">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="username" name="username" required autocomplete="username" value="admin">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required autocomplete="current-password" value="admin123">
                </div>
                
                <button type="button" class="login-btn" id="loginBtn" onclick="handleLogin()">
                    –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                </button>
            </form>
            
            <div class="test-accounts">
                <strong>–¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã:</strong><br>
                –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: <code>admin / admin123</code><br>
                –û–ø–µ—Ä–∞—Ç–æ—Ä: <code>operator1 / operator123</code>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div class="main-screen" id="mainScreen">
            <div class="header">
                <h1>üè† –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div>
                        <div id="userName"></div>
                        <div id="userRole" style="font-size: 12px; color: #666;"></div>
                    </div>
                    <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="web-notice">
                ‚úÖ –í–µ–±-–≤–µ—Ä—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! Backend –Ω–∞ Express.js, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞.
            </div>
            
            <div class="status-grid" id="statusGrid">
                <div class="status-card">
                    <div class="status-value" id="apartmentsCount">-</div>
                    <div class="status-label">–ö–≤–∞—Ä—Ç–∏—Ä</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="camerasCount">-</div>
                    <div class="status-label">–ö–∞–º–µ—Ä</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="connectionStatus">-</div>
                    <div class="status-label">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</div>
                </div>
            </div>
            
            <div id="content">
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!</h3>
                <p>–í–µ–±-–≤–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>
                <button onclick="loadSystemData()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
                </button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤
        async function invoke(endpoint, payload) {
            const url = endpoint.startsWith('/') ? endpoint : `/api/${endpoint}`;
            const response = await fetch(url, {
                method: payload ? 'POST' : 'GET',
                headers: payload ? { 'Content-Type': 'application/json' } : {},
                body: payload ? JSON.stringify(payload) : undefined
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        }

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const loginCard = document.getElementById('loginCard');
        const mainScreen = document.getElementById('mainScreen');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const loginBtn = document.getElementById('loginBtn');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            setupEventListeners();
            
            // –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            try {
                const status = await invoke('system-status');
                console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', status);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥–∞
        async function handleLogin() {
            console.log('üîê –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            console.log('üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:', { login: username, password: '***' });
            
            setLoading(true);
            hideMessages();
            
            try {
                const response = await invoke('login', {
                    login: username,
                    password: password
                });
                
                console.log('üì® –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                
                if (response.success && response.user) {
                    currentUser = response.user;
                    showSuccess('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    
                    setTimeout(() => {
                        showMainScreen();
                        loadSystemStatus();
                    }, 1000);
                } else {
                    showError(response.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        async function handleLogout() {
            try {
                await invoke('logout');
                currentUser = null;
                showLoginScreen();
                console.log('üö™ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        function showLoginScreen() {
            loginCard.classList.remove('hidden');
            mainScreen.classList.remove('active');
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            hideMessages();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showMainScreen() {
            loginCard.classList.add('hidden');
            mainScreen.classList.add('active');
            updateUserInfo();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function updateUserInfo() {
            if (!currentUser) return;
            
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            if (userAvatar) {
                userAvatar.textContent = currentUser.login.charAt(0).toUpperCase();
            }
            
            if (userName) {
                userName.textContent = currentUser.login;
            }
            
            if (userRole) {
                const roleText = currentUser.role === 'Admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–û–ø–µ—Ä–∞—Ç–æ—Ä';
                userRole.textContent = roleText;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
        async function loadSystemStatus() {
            try {
                const status = await invoke('system-status');
                console.log('üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:', status);
                
                document.getElementById('apartmentsCount').textContent = status.apartments_count || 0;
                document.getElementById('camerasCount').textContent = status.cameras_count || 0;
                document.getElementById('connectionStatus').textContent = status.is_authenticated ? '‚úÖ' : '‚ùå';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã
        async function loadSystemData() {
            try {
                const config = await invoke('config');
                console.log('üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã:', config);
                
                const content = document.getElementById('content');
                content.innerHTML = `
                    <h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h3>
                    <p><strong>–ö–≤–∞—Ä—Ç–∏—Ä—ã (${config.apartments.length}):</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${config.apartments.map(apt => `<li>${apt.apartment_name} (${apt.apartment_number})</li>`).join('')}
                    </ul>
                    <p><strong>–ö–∞–º–µ—Ä—ã (${config.cameras.length}):</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${config.cameras.map(cam => `<li>${cam.camera_name} - ${cam.apartment_name}</li>`).join('')}
                    </ul>
                    <button onclick="loadSystemData()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                        –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function setLoading(loading) {
            if (loading) {
                loginBtn.disabled = true;
                loginBtn.textContent = '–í—Ö–æ–¥...';
                loginCard.classList.add('loading');
            } else {
                loginBtn.disabled = false;
                loginBtn.textContent = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
                loginCard.classList.remove('loading');
            }
        }
    </script>
</body>
</html>
